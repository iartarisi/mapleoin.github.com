<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="https://fonts.googleapis.com/css?family=Oxygen" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Noto Sans" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="/css/style.css" />
<link rel="stylesheet" type="text/css" href="/css/pygments.css" />
<link rel="stylesheet" type="text/css" href="/css/archive.css" />
<link rel="shortcut icon" href="/favico.ico" />
<link rel="alternate" type="application/rss+xml" title="RSS" href="/tag/python.xml" />
<title>Revolution blahg 
    | Articles tagged python
</title>
</head>
<body>
<div id="container">
  <div id="header">
    <h1><a href="/" class="title">Revolution blahg</a></h1>
    <a href="/">home</a>
    <a href="/archive">archive</a>
    <a href="/about">about</a>
  </div>
<div id="content">
    <article id="python-uk-business-days">
        <h2><a href="http://mapleoin.github.io/perma/python-uk-business-days">Python UK business days with pandas</a></h2>
        <div class="postmeta">Wednesday, March  2, 2016</div>

        <div class="entry">
            	<p>Here&#8217;s how to calculate UK business days (well at least for England &amp; Wales) using <a href="http://pandas.pydata.org">pandas</a>&#8217;s holiday calendar.</p>

	<p>First you&#8217;ll need this calendar for UK holidays:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pandas.tseries.holiday</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AbstractHolidayCalendar</span><span class="p">,</span> <span class="n">DateOffset</span><span class="p">,</span> <span class="n">EasterMonday</span><span class="p">,</span>
    <span class="n">GoodFriday</span><span class="p">,</span> <span class="n">Holiday</span><span class="p">,</span> <span class="n">MO</span><span class="p">,</span>
    <span class="n">next_monday</span><span class="p">,</span> <span class="n">next_monday_or_tuesday</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">EnglandAndWalesHolidayCalendar</span><span class="p">(</span><span class="n">AbstractHolidayCalendar</span><span class="p">):</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Holiday</span><span class="p">(</span><span class="s1">&#39;New Years Day&#39;</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">observance</span><span class="o">=</span><span class="n">next_monday</span><span class="p">),</span>
        <span class="n">GoodFriday</span><span class="p">,</span>
        <span class="n">EasterMonday</span><span class="p">,</span>
        <span class="n">Holiday</span><span class="p">(</span><span class="s1">&#39;Early May bank holiday&#39;</span><span class="p">,</span>
                <span class="n">month</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">weekday</span><span class="o">=</span><span class="n">MO</span><span class="p">(</span><span class="mi">1</span><span class="p">))),</span>
        <span class="n">Holiday</span><span class="p">(</span><span class="s1">&#39;Spring bank holiday&#39;</span><span class="p">,</span>
                <span class="n">month</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">weekday</span><span class="o">=</span><span class="n">MO</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))),</span>
        <span class="n">Holiday</span><span class="p">(</span><span class="s1">&#39;Summer bank holiday&#39;</span><span class="p">,</span>
                <span class="n">month</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">weekday</span><span class="o">=</span><span class="n">MO</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))),</span>
        <span class="n">Holiday</span><span class="p">(</span><span class="s1">&#39;Christmas Day&#39;</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">observance</span><span class="o">=</span><span class="n">next_monday</span><span class="p">),</span>
        <span class="n">Holiday</span><span class="p">(</span><span class="s1">&#39;Boxing Day&#39;</span><span class="p">,</span>
                <span class="n">month</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">26</span><span class="p">,</span> <span class="n">observance</span><span class="o">=</span><span class="n">next_monday_or_tuesday</span><span class="p">)</span>
    <span class="p">]</span>
</pre></div>
</div>


	<p>It was tested with the dates from <a href="https://www.gov.uk/bank-holidays">gov.uk</a> so should be fine to use, but please let me know if you find anything wrong with it.</p>

	<p>Now you can do stuff like:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">pandas.tseries.offsets</span> <span class="kn">import</span> <span class="n">CDay</span>
<span class="n">business</span> <span class="o">=</span> <span class="n">CDay</span><span class="p">(</span><span class="n">calendar</span><span class="o">=</span><span class="n">EnglandAndWalesHolidayCalendar</span><span class="p">())</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">five_business_days_later</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">business</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">five_business_days_later</span>
<span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2016-03-09 00:00:00&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">five_business_days_later</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">business</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">date</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="n">business</span>
<span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2016-12-28 00:00:00&#39;</span><span class="p">)</span>
</pre></div>
</div>

	<p>You can also just retrieve the UK holidays for a specific year as a list of datetime objects using e.g.:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">holidays</span> <span class="o">=</span> <span class="n">EnglandAndWalesHolidayCalendar</span><span class="p">()</span><span class="o">.</span><span class="n">holidays</span><span class="p">(</span>
    <span class="n">start</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">end</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">holidays</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="p">[</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2016-01-01 00:00:00&#39;</span><span class="p">),</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2016-03-25 00:00:00&#39;</span><span class="p">),</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2016-03-28 00:00:00&#39;</span><span class="p">),</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2016-05-02 00:00:00&#39;</span><span class="p">),</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2016-05-30 00:00:00&#39;</span><span class="p">),</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2016-08-29 00:00:00&#39;</span><span class="p">),</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2016-12-26 00:00:00&#39;</span><span class="p">),</span> <span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2016-12-27 00:00:00&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">holidays</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
<span class="n">array</span><span class="p">([</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
       <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
       <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
       <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
       <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
       <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
       <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
       <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">h</span><span class="o">.</span><span class="n">to_native_types</span><span class="p">()</span>
<span class="p">[</span><span class="s1">&#39;2016-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2016-03-25&#39;</span><span class="p">,</span> <span class="s1">&#39;2016-03-28&#39;</span><span class="p">,</span> <span class="s1">&#39;2016-05-02&#39;</span><span class="p">,</span> <span class="s1">&#39;2016-05-30&#39;</span><span class="p">,</span> <span class="s1">&#39;2016-08-29&#39;</span><span class="p">,</span> <span class="s1">&#39;2016-12-26&#39;</span><span class="p">,</span> <span class="s1">&#39;2016-12-27&#39;</span><span class="p">]</span>
</pre></div>
</div>

	<p>Pandas has all sorts of funny stuff you can do with <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.Series.html">series</a> and <a href="http://pandas.pydata.org/pandas-docs/stable/timeseries.html">time series</a> in particular. Also check <code>pandas</code>&#8217;s docs about <a href="http://pandas.pydata.org/pandas-docs/stable/timeseries.html#custom-business-days-experimental">Custom Business Days</a> especially the warning about possible timezone issues.</p>

	<p>If you don&#8217;t need the power of <code>pandas</code> or you just don&#8217;t like it (maybe because it pulls in a bazillion dependencies and includes a gazillion modules), <a href="https://github.com/novafloss/workalendar">workalendar</a> looks pretty good.</p>
        </div>
        <div class="post_tags postmeta">
          tags:
                <a href="/tag/TIL.html">TIL</a>
                <a href="/tag/programming.html">programming</a>
                <a href="/tag/python.html">python</a>
                <a href="/tag/pandas.html">pandas</a>
        </div>
        <a href="http://mapleoin.github.io/perma/python-uk-business-days#disqus_thread" class="comments">Comments</a>
    </article>
    <article id="python-class-meta">
        <h2><a href="http://mapleoin.github.io/perma/python-class-meta">The origins of the class Meta idiom in python</a></h2>
        <div class="postmeta">Sunday, February 28, 2016</div>

        <div class="entry">
            	<p>So I keep finding this <code>class Meta</code> idiom in python <span class="caps">API</span>s lately. Found it in <a href="http://factoryboy.readthedocs.org/en/latest/index.html">factory-boy</a> and <a href="https://wtforms.readthedocs.org/en/latest/meta.html"><span class="caps">WTF</span>orms</a> and I suspected they both got it from <a href="https://docs.djangoproject.com/en/1.9/topics/db/models/#meta-options">Django</a>, but I googled and couldn&#8217;t find any explanations of the reason for it or where it came from or why they all call it <code>class Meta</code>. So here it is!</p>

	<h4>TL;DR What it is</h4>

	<p>The inner <code>Meta</code> class has absolutely no relation to python&#8217;s <a href="https://www.python.org/doc/essays/metaclasses/">metaclasses</a>. The name is just a coincidence of history (as you can read below).</p>

	<p>There&#8217;s nothing magical about this syntax at all, here&#8217;s an example from Django&#8217;s documentation:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Ox</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">horn_length</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;horn_length&quot;</span><span class="p">]</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s2">&quot;oxen&quot;</span>
</pre></div>
</div>

	<p>Having an inner <code>Meta</code> class makes it easier for both the users and the <span class="caps">ORM</span> to tell what is a field on the model and what is just other information (or metadata if you like) about the model. The <span class="caps">ORM</span> can simply do <code>your_model.pop('Meta')</code> to retrieve the information it needs. You can also do this in any library you implement just as <code>factory-boy</code> and <code>WTForms</code> have done.</p>

	<h4>Some early Django history</h4>

	<p>Now for the longer story. I did some software archaeology, which should totally be a thing!, and discovered the first commit which mentions <code>class Meta</code> (actually <code>class META</code><sup class="footnote" id="fnrevd9ec3b3e17e549c6bccec804d6d0bc82-1"><a href="#fnd9ec3b3e17e549c6bccec804d6d0bc82-1">1</a></sup>) in Django: <a href="https://github.com/django/django/commit/25264c86048d442a4885dfebae94510e2fa0c1e4">commit 25264c86</a>. There is a <a href="https://code.djangoproject.com/wiki/ModelSyntaxChangeInstructions">Release Notes wiki page</a> which includes that change.</p>

	<p>From there we can see how Django models were declared before the introduction of the internal <code>class Meta</code>. A Django Model class had a few special attributes. The <code>db_table</code> attribute held the <span class="caps">SQL</span> table name. A <code>fields</code> attribute was a tuple (!) of instances of field types (e.g. <code>CharField</code>, <code>IntegerField</code>, <code>ForeignKey</code>). These mapped to <span class="caps">SQL</span> table columns. One other interesting attribute was <code>admin</code> which was mostly used to describe how that model would behave in django&#8217;s admin interface. Now all these classes were defined in the <code>django.core.meta</code> package i.e. <code>meta.Model</code>, <code>meta.CharField</code>, <code>meta.ForeignKey</code>, <code>meta.Admin</code>. <em>That&#8217;s so meta!</em> (and probably where the name came from in the end)</p>

	<p>In a <code>django-developers</code> mailing list thread from July 2005 titled <cite><a href="https://groups.google.com/forum/#!msg/django-developers/IZdH8K8IbLA/AIJGlt8d3icJ">Cleaner approach to <span class="caps">ORM</span> fields description</a></cite> user <code>deelan</code> suggests bringing some of <a href="https://en.wikipedia.org/wiki/SQLObject"><span class="caps">SQLO</span>bject</a> &#8216;s ideas to Django&#8217;s <span class="caps">ORM</span>. This seems to be the first seed of the idea of having an inner class in Django to store part of a model&#8217;s attributes:</p>

	<blockquote>
		<p>it&#8217;s desiderable to avoid name clashes between fields, so it would be<br />
good to have a way to wrap fields into a private namespace.<br />
<cite>&#8212; <code>deelan</code>, <a href="https://groups.google.com/forum/#!msg/django-developers/IZdH8K8IbLA/AIJGlt8d3icJ">Cleaner approach to <span class="caps">ORM</span> fields description</a></cite></p>
	</blockquote>

	<p>At the end of the thread, <a href="https://code.djangoproject.com/ticket/122">django ticket 122</a> is created which seems to contain the first mention of a separate internal <code>Meta</code> class.</p>

	<p>What started off as a backwards-compatible change, soon turned backwards-incompatible and was <q cite="https://groups.google.com/d/msg/django-developers/z_eGMWTJBqk/Fa3xur7J0jwJ">the first really big community-driven improvement to Django</q> as Adrian Holovaty will later describe it in the release announcement which included the change.</p>

	<p>The first patch on <a href="%3Ahttps%3A//code.djangoproject.com/ticket/122">ticket 122</a> by Matthew Marshall started by suggesting that fields should be able to be defined directly on the model class, as class attributes (<em>Build models using fieldname=FieldClass</em>) rather than in the <code>fields</code> list. So:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Poll</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">maxlength</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="s1">&#39;date published&#39;</span><span class="p">)</span>
</pre></div>
</div>

	<p>rather than:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Poll</span><span class="p">(</span><span class="n">meta</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">maxlength</span><span class="o">=</span><span class="mi">200</span><span class="p">),</span>
        <span class="n">pub_date</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="s1">&#39;date published&#39;</span><span class="p">),</span>
    <span class="p">)</span>
</pre></div>
</div>

	<p>But also that there should be two ways of defining a <code>ForeignKey</code>:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="n">ForeignKey</span> <span class="o">=</span> <span class="n">Poll</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;edit_inline&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span> <span class="s1">&#39;num_in_admin&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">}</span>
<span class="o">.</span>
<span class="c1">#the attribute name is irrelevant here:</span>
<span class="n">anything</span> <span class="o">=</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="n">Poll</span><span class="p">,</span> <span class="n">edit_inline</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">num_in_admin</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>

	<p>In his first comment, <code>mmarshall</code> introduces the inner <code>class Meta</code> to hold anything that&#8217;s not a field: the table name (strangely renamed to <code>module_name</code>) and the admin options. The fields would be class attributes.</p>

	<p>The decision over what goes in an inner class and what goes in the outer class seems to be left to the user. An optional <code>class Field</code> inner class would be supported so the fields would live there and the metadata would live as class attributes (this seemed to offer the advantage of being backwards-compatible with the <code>admin</code> class attribute while allowing tables to have a column that&#8217;s also named <code>admin</code>.</p>

	<p>There are some other ideas thrown around and the syntax for <code>ForeignKey</code> is also discussed. At one point, Adrian Holovaty (<code>adrian</code>) intervenes to say (about the original <code>class Meta/class Field</code> suggestion):</p>

	<blockquote>
		<p>It&#8217;s too flexible, to the point of confusion. Making it possible to do either class Meta or class Field or plain class attributes just smacks of &#8220;there&#8217;s more than one way to do it.&#8221; There should be one, clear, obvious way to do it. If we decide to change model syntax, let&#8217;s have class Meta for non-field info, and all fields are just attributes of the class.<br />
<cite>&#8212; Adrian Holovaty, <a href="https://code.djangoproject.com/ticket/122#comment:9">django ticket 122, comment 9</a></cite></p>
	</blockquote>

	<p>The thread goes on from there. There are some detractors to the idea (citing performance and conformance to other python <span class="caps">API</span>s), there are discussions about implementation details and talking again about the <code>ForeignKey</code> syntax.</p>

	<p>Then, in a dramatic turn of events, Adrian Holovaty <strong>closes the ticket as wontfix!</strong>:</p>

	<blockquote>
		<p>Jacob [Kaplan-Moss] and I have talked this over at length, and we&#8217;ve decided the model syntax shouldn&#8217;t change. Using a fieldname=FieldClass syntax would require too much &#8220;magic&#8221; behind the scenes for minimal benefit.<br />
<cite>&#8212; Adrian Holovaty, <a href="https://code.djangoproject.com/ticket/122#comment:33">django ticket 122, comment 33</a></cite></p>
	</blockquote>

	<p>It&#8217;s interesting, because <span class="caps">IMHO</span> this was a huge differentiator in terms of making django&#8217;s models <span class="caps">API</span> more human and was also what other frameworks like Rails and <span class="caps">SQLO</span>bject were doing at the time.</p>

	<p>An <a href="https://code.djangoproject.com/attachment/ticket/122/modeldiscuss_cleanedup.txt"><span class="caps">IRC</span> discussion</a> is then referenced in the ticket.<sup class="footnote" id="fnrevd9ec3b3e17e549c6bccec804d6d0bc82-2"><a href="#fnd9ec3b3e17e549c6bccec804d6d0bc82-2">2</a></sup> From that discussion, it seems that <code>adrian</code>&#8217;s reasons for closing were mostly concerns about the <code>ForeignKey</code> syntax and making a backwards-incompatible change to the model. <code>rmunn</code> does a great job of moderating the discussion, clarifying the situation and everyone&#8217;s opinions while strongly pushing for the new syntax.</p>

	<p>The trac ticket is reopened as a consequence and it looks like smooth-sailing from the on. Some days later the new syntax is merged and the ticket is once again closed, this time with <em>Resolution</em> set to <em>fixed</em>.</p>

	<p>Adrian will later announce the change in a <code>django-developers</code> mailing list post. Here are some interesting fragments from that mailing list post:</p>

	<p><blockquote><br />
I apologize for the backwards-incompatibility, but this is still unofficial software. ;-) Once we reach 1.0 &#8212; which is much closer now that the model syntax is changed &#8212; we&#8217;ll be very dedicated to backwards-compatibility.</p>

	<p>I can&#8217;t think of any other backwards-incompatible changes that we&#8217;re planning before 1.0 (knock on wood). If this isn&#8217;t the last one, though, it&#8217;s at least the last <strong>major</strong> one.<br />
<cite>&#8212; Adrian Holovaty, <a href="https://groups.google.com/d/msg/django-developers/z_eGMWTJBqk/Fa3xur7J0jwJ"><span class="caps">IMPORTANT</span>: Django model syntax is changing</a></cite><br />
</blockquote></p>

	<p>Things didn&#8217;t go as planned. In May 2006, came <a href="https://github.com/django/django/commit/f69cf70ed813a8cd7e1f963a14ae39103e8d5265">commit f69cf70e</a> which was exactly another <em>let&#8217;s-change-everything-in-one-huge-branch</em> commit which was released as part of Django <strong>0.95</strong>. As part of this <span class="caps">API</span> change, <code>class META</code> was renamed to <code>class Meta</code> (because it&#8217;s <em>easier on the eyes</em>). You can find the details on <a href="https://code.djangoproject.com/wiki/RemovingTheMagic">RemovingTheMagic wiki page</a>. It&#8217;s funny how in <a href="https://code.djangoproject.com/ticket/122">ticket 122</a> all the comments use the <code>Meta</code> capitalization, except for the last person (who I guess submitted the patch) who uses <code>META</code>. There was some discussion, both in the ticket and on <span class="caps">IRC</span>, about it and a few people had concerns that users of Django would actually want to have a field called <code>Meta</code> in their models and the inner class name would clash with that.</p>

	<h4>That&#8217;s it. Almost&#8230;</h4>

	<p>Anyway, so that&#8217;s the end of the story of how Django got its <code>class Meta</code>. Now what if I told you that all of this had already happened more than one year before in the <span class="caps">SQLO</span>bject project? Remember that first post to <code>django-developers</code> which said Django models should hold some of its attributes in a separate inner class like <span class="caps">SQLO</span>bject already does?</p>

	<p>In April 2004, Ian Bicking (creator of <span class="caps">SQLO</span>bject) sent an email to the <code>sqlobject-discuss</code> mailing list:</p>

	<blockquote>
		<p>There&#8217;s a bunch of metadata right now that is being stored in various instance variables, all ad hoc like, and with no introspective interfaces.  I&#8217;d like to consolidate these into a single object/class that is separated from the <span class="caps">SQLO</span>bject class.  This way I don&#8217;t have to worry about name clashes, and I don&#8217;t feel like every added little interface will be polluting people&#8217;s classes.  (Though most of the public methods that are there now will remain methods of the <span class="caps">SQLO</span>bject subclasses, just like they are now)  So I&#8217;m looking for feedback on how that should work.<br />
<cite>&#8212; Ian Bicking, <a href="https://sourceforge.net/p/sqlobject/mailman/message/7522562/">Metadata container</a></cite></p>
	</blockquote>

	<p>His code example:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Contact</span><span class="p">(</span><span class="n">SQLObject</span><span class="p">):</span>
     <span class="k">class</span> <span class="nc">sqlmeta</span><span class="p">(</span><span class="n">SQLObject</span><span class="o">.</span><span class="n">sqlmeta</span><span class="p">):</span>
         <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;contact_table&#39;</span>
         <span class="n">cacheInstances</span> <span class="o">=</span> <span class="bp">False</span>
     <span class="n">name</span> <span class="o">=</span> <span class="n">StringCol</span><span class="p">()</span>
</pre></div>
</div>

	<p><span class="caps">SQLO</span>bject&#8217;s community did not seem nearly as animated as Django&#8217;s. There were a couple of emails on the <code>sqlobject-discuss</code> mailing list from Ian Bicking which included the proposal and asked for feedback. I suspect some discussion happened through some other channels, but this community was neither as big nor as good at docummenting its functioning as Django. (And sourceforge&#8217;s interface to the mailing list archives and cvs logs does not make this easy to navigate).</p>

	<p>A year later, Ian Bicking takes part in the <code>django-developers</code> mailinglist discussion where he makes some small syntax suggestions, but it does not seem that he made any other contributions to the design of this part of the Django models <span class="caps">API</span>.</p>

	<h4>Conclusion</h4>

	<p>As far as I could tell, Ian Bicking is the originator of the idea of storing metadata in a <strong>metadata container</strong> inner class. Although it was the Django project which settled on the <code>class Meta</code> name and popularised it outside of its own community.</p>

	<p>Anyway, that&#8217;s the end of the story. To me, it shows just how awesome open source and the open internet can be. The fact that I was able to find all of this 11 years later, complete with the original source code, commit logs and all the discussion around the implementation on the issue tracker, mailing lists and <span class="caps">IRC</span> logs is just amazing community work and puts a tear in my eye.</p>

	<p>Hope you&#8217;ve enjoyed the ride!</p>

	<p class="footnote" id="fnd9ec3b3e17e549c6bccec804d6d0bc82-1"><sup>1</sup> because in 2005, people were less soft-spoken</p>

	<p class="footnote" id="fnd9ec3b3e17e549c6bccec804d6d0bc82-2"><sup>2</sup> It&#8217;s very fun, you should read it. At some point someone&#8217;s cat catches a blue jay. And I think they meant it literally.</p>
        </div>
        <div class="post_tags postmeta">
          tags:
                <a href="/tag/python.html">python</a>
                <a href="/tag/django.html">django</a>
                <a href="/tag/foss.html">foss</a>
        </div>
        <a href="http://mapleoin.github.io/perma/python-class-meta#disqus_thread" class="comments">Comments</a>
    </article>
    <article id="pytest-run-one-test-inside-class">
        <h2><a href="http://mapleoin.github.io/perma/pytest-run-one-test-inside-class">Run py.test test case inside any python class</a></h2>
        <div class="postmeta">Tuesday, February 23, 2016</div>

        <div class="entry">
            	<p>I wanted a way to run the current test I was editing when I know the name of the method, but I&#8217;m too lazy to scroll up and see which class it&#8217;s defined in and then have to type that out as well. So I found a way for py.test to run any test in any class in a file by just giving it the name of that test or part of its name.</p>

	<p>Instead of typing:</p>

<pre>
$ py.test path/to/my/test/test_file.py::MySuperLongClassNameTest::test_my_thing
</pre>

	<p>I can just type:</p>

<pre>
$ py.test path/to/my/test/test_file.py -k test_my_thing
</pre>

	<p>Or even:</p>

<pre>
$ py.test path/to/my/test/test_file.py -k test_my
</pre>

	<p>Or even:</p>

<pre>
$ py.test path/to/my/test/test_file.py -k &quot;thing or stuff&quot;
</pre>

	<p>Woo py.test!</p>

	<p><span class="caps">FWIW</span>, <code>nosetests</code> can also do this with the <code>-m</code> option which supports regexp. But <span class="caps">AFAIK</span> it does not support the human-friendly <code>" or "</code> interface like in the last example above.</p>
        </div>
        <div class="post_tags postmeta">
          tags:
                <a href="/tag/TIL.html">TIL</a>
                <a href="/tag/py.test.html">py.test</a>
                <a href="/tag/python.html">python</a>
                <a href="/tag/testing.html">testing</a>
        </div>
        <a href="http://mapleoin.github.io/perma/pytest-run-one-test-inside-class#disqus_thread" class="comments">Comments</a>
    </article>
    <article id="ast-literal-eval">
        <h2><a href="http://mapleoin.github.io/perma/ast-literal-eval">AST literal_eval</a></h2>
        <div class="postmeta">Monday, February 15, 2016</div>

        <div class="entry">
            	<p><blockquote><br />
Safely evaluate an expression node or a Unicode or Latin-1 encoded string containing a Python literal or container display. The string or node provided may only consist of the following Python literal structures: strings, numbers, tuples, lists, dicts, booleans, and None.</p>

	<p>This can be used for safely evaluating strings containing Python values from untrusted sources without the need to parse the values oneself. It is not capable of evaluating arbitrarily complex expressions, for example involving operators or indexing.</p>

	<p><cite>&#8212;From python&#8217;s <a href="https://docs.python.org/library/ast.html#ast.literal_eval">ast library</a></cite><br />
</blockquote></p>

	<p>I used to discredit everything that meant converting a string to an arbitrary data structure. This is a nice third option which seems like it would be useful in the majority of cases.</p>
        </div>
        <div class="post_tags postmeta">
          tags:
                <a href="/tag/TIL.html">TIL</a>
                <a href="/tag/python.html">python</a>
                <a href="/tag/programming.html">programming</a>
        </div>
        <a href="http://mapleoin.github.io/perma/ast-literal-eval#disqus_thread" class="comments">Comments</a>
    </article>
    <article id="change-external-timezone-in-python">
        <h2><a href="http://mapleoin.github.io/perma/change-external-timezone-in-python">Change the system timezone for the python interpreter</a></h2>
        <div class="postmeta">Saturday, February 13, 2016</div>

        <div class="entry">
            	<p>Wrapping my head around timezones is hard. And testing the implications of working with different timezones is especially difficult since I now live in <span class="caps">GMT</span> (which is mostly the same as <span class="caps">UTC</span>).</p>

	<p>I found a way to change the timezone, that is used by most of python&#8217;s stdlib, by changing the <code>TZ</code> environment variable:</p>

<div class="Bash"><div class="highlight"><pre><span></span>$ python -c <span class="s1">&#39;import time; print(time.tzname)&#39;</span>
<span class="o">(</span><span class="s1">&#39;GMT&#39;</span>, <span class="s1">&#39;BST&#39;</span><span class="o">)</span>
$ <span class="nv">TZ</span><span class="o">=</span><span class="s1">&#39;Europe/Stockholm&#39;</span> python -c <span class="s1">&#39;import time; print(time.tzname)&#39;</span>
<span class="o">(</span><span class="s1">&#39;CET&#39;</span>, <span class="s1">&#39;CEST&#39;</span><span class="o">)</span>
</pre></div>
</div>
        </div>
        <div class="post_tags postmeta">
          tags:
                <a href="/tag/programming.html">programming</a>
                <a href="/tag/python.html">python</a>
                <a href="/tag/timezones.html">timezones</a>
                <a href="/tag/TIL.html">TIL</a>
        </div>
        <a href="http://mapleoin.github.io/perma/change-external-timezone-in-python#disqus_thread" class="comments">Comments</a>
    </article>
    <article id="mocking-python-file-open">
        <h2><a href="http://mapleoin.github.io/perma/mocking-python-file-open">Mocking python's file open() builtin</a></h2>
        <div class="postmeta">Thursday, November 15, 2012</div>

        <div class="entry">
            	<p>I was working on a method to read some proxy information from several files today and then I wanted to test it.</p>

	<p>A <em>very</em> simplified version (the original has all the different files being processed in different functions on different rules and it actually has error handling) of this function is this:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="n">SYS_PROXY</span> <span class="o">=</span> <span class="s1">&#39;/etc/sysconfig/proxy&#39;</span>
<span class="n">CURL_PROXY</span> <span class="o">=</span> <span class="s1">&#39;/root/.curlrc&#39;</span>
<span class="k">def</span> <span class="nf">get_proxy</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">SYS_PROXY</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;http_proxy&#39;</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;http_proxy = &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
            <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">proxy</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CURL_PROXY</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;--proxy&#39;</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;--proxy &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
            <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">proxy</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;http_proxy&#39;</span><span class="p">)</span>
</pre></div>
</div>

	<p>As unit tests should be self-contained, they shouldn&#8217;t read any files on disk. So we need to mock them. I generally use Michael Foord&#8217;s <a href="http://www.voidspace.org.uk/python/mock/">mock</a>.</p>

	<p>In order to intercept calls to python&#8217;s <a href="http://docs.python.org/2/library/functions.html#open">open()</a>, we need to mock the <code>builtins.open</code> function:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="n">TEST_PROXY</span> <span class="o">=</span> <span class="s1">&#39;http://example.com:1111&#39;</span>
<span class="k">def</span> <span class="nf">test_proxy_url_in_sysproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span>
                    <span class="n">return_value</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;http_proxy = &quot;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">)):</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
</pre></div>
</div>

	<p>We&#8217;re good so far. Now we add the next natural test: we didn&#8217;t find anything in sysconfig, but we find the right proxy <span class="caps">URL</span> on our second try in <code>CURL_PROXY</code>:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_proxy_url_not_in_sysproxy_but_in_yastproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()):</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span>
                        <span class="n">return_value</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s1">&#39; --proxy &#39;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
</pre></div>
</div>

	<p>Urgh. That&#8217;s starting to look a bit clunky. It&#8217;s also wrong since the inner <code>with statement</code> ends up overriding the outer one and all we get for our second <code>open()</code> call is a <i>closed</i> file object:</p>

<pre>ValueError: I/O operation on closed file.</pre>

	<p>Not to worry though. <code>mock</code> <a href="http://www.voidspace.org.uk/python/mock/mock.html#mock.Mock.side_effect">side_effect</a> have got us covered!</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_proxy_url_not_in_sysproxy_but_in_yastproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s2">&quot;builtins.open&quot;</span><span class="p">,</span>
                    <span class="n">side_effect</span><span class="o">=</span><span class="p">[</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(),</span>
                                 <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s1">&#39; --proxy &#39;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">)]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
</pre></div>
</div>

	<p>The code looks cleaner now. A bit. And at least it works. But the list we pass in to <code>side_effect</code> makes another issue pop up. We now seem to be dependent on the order that the files are opened and read. That seems clunky. If we had to refactor our code to change the order that we read files in <code>get_proxy()</code> we would also had to change all our tests. Also it&#8217;s not quite obvious why we&#8217;re setting our return values as side effects.</p>

	<p>Ideally we&#8217;d have a way to assign each result to a filename and then not have to care about the order in which the files are open. In real life we would have two files with different contents anyway.</p>

	<p>So let&#8217;s implement that method. We, of course, want to make it a context manager.</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">mock_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">mock_file</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_file</span><span class="p">):</span>
        <span class="k">yield</span>
</pre></div>
</div>

	<p>So we only intercept the filename that we want to mock and let everything else pass through to <code>builtins.open()</code>. The <code>yield</code> is there because a contextmanager should be a generator function. Everything before the <code>yield</code> gets executed when entering the <code>with mock_open ...</code> statement, then the content of the <code>with</code> block is executed and then everything after the <code>yield</code> in our mock_open function (there&#8217;s nothing there in our case).</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_proxy_url_not_in_sysproxy_but_in_yastproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">SYS_PROXY</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">CURL_PROXY</span><span class="p">,</span> <span class="s1">&#39; --proxy &#39;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
</pre></div>
</div>

	<p>Looks good.</p>

<pre>RuntimeError: maximum recursion depth exceeded in comparison</pre>

	<p>Oops. It seems that we got into infinite recursion because we&#8217;re calling the mocked <code>open()</code> from the mocking function. We have to make sure that once we&#8217;ve mocked a call to <code>open()</code>, there&#8217;s no way we&#8217;re going to go through that mock again. Thankfully, the mock library provides methods to turn mocking on and off without using the <code>with mock.patch</code> context manager. Take a look at <code>mock.patch</code>&#8217;s <a href="http://www.voidspace.org.uk/python/mock/patch.html#patch-methods-start-and-stop">start and stop methods</a>.</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">mock_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">mock_file</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">open_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">open_file</span>
    <span class="n">mocked_file</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_file</span><span class="p">)</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>

	<p>So we had to replace the <code>with mock.patch</code> statement with manually <code>start()</code>-ing and <code>stop()</code>-ing the mocking functionality before and after the <code>yield</code>. That&#8217;s basically what the <code>with</code> statement was doing, we just needed the indentifier so we can use it in the <code>else</code> branch.</p>

	<p>In the <code>else</code> branch we turn off the mocking before calling <code>open()</code> (that&#8217;s what was causing us to go in the infinite loop). After we&#8217;ve called <code>open()</code>, we go back to mocking <code>open()</code>, in case there will be a future call that we actually do want to mock.</p>

	<p>Test code now looks the same as before:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_proxy_url_not_in_sysproxy_but_in_yastproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">SYS_PROXY</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">CURL_PROXY</span><span class="p">,</span> <span class="s1">&#39; --proxy &#39;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
</pre></div>
</div>

	<p>But this time it works. So we could all go home now.</p>

	<p>But say we wanted to ensure that no files were opened inside the <code>with mock_open</code> block other than the ones we mocked. It seems like a pretty sensible thing to do. Unit tests should be completely self-contained so you want to ensure they won&#8217;t be opening any files on the system. This would also catch some bugs that might only later pop-up on your CI server&#8217;s test runs, because of a custom development machine configuration.</p>

	<p>The problem is pretty simple if you use only one <code>with mock_open</code> block, but once you start using more than one nested contest managers you have a problem. You need to have a way to communicate between the different context-managers. Ideally you&#8217;d have a way for each context-manager to say to the others (after it&#8217;s finished processing): <em>hey, I finished my work here, but some dude opened a file which I didn&#8217;t mock. Did you mock it?</em>.</p>

	<p>So how do we solve that? We&#8217;ll use <code>global</code> variables! No. Just kidding.</p>

	<p>We&#8217;ll use exceptions. Simply make the inner statement raise a custom <code>NotMocked</code> exception and let the enclosing context managers catch.If none of the enclosing context managers mock the file that was opened in the inner block, they just let the user deal with the exception.</p>

	<p>So the exception can be a normal <code>Exception</code> subclass, but we need an extra bit of information, the <code>filename</code> that wasn&#8217;t mocked. I&#8217;ll also hardcode an error message in there:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NotMocked</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NotMocked</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s2">&quot;The file </span><span class="si">%s</span><span class="s2"> was opened, but not mocked.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
</pre></div>
</div>

	<p>The updated <code>mock_open</code> code looks like this:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">mock_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">complain</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">open_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">mock_file</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">open_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="n">mocked_file</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_file</span><span class="p">)</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="n">NotMocked</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">filename</span> <span class="o">!=</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">open_file</span> <span class="ow">in</span> <span class="n">open_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">complain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotMocked</span><span class="p">(</span><span class="n">open_file</span><span class="p">)</span>
</pre></div>
</div>

	<p>So we&#8217;re recording all the files that were opened in the <code>open_files</code> list. Then after all the code inside the <code>with</code> block was executed, we go through the <code>open_files</code> list and raise a <code>NotMocked</code> exception for each of those file names. We also added a new <code>complain</code> parameter just in case someone would like to turn this functionality off (maybe they want to use file fixtures after all).</p>

	<p>The StringIO objects now also have a <code>name</code> attribute. It&#8217;s a bit tricky to see why this is needed since at first sight those objects never get into the open_files list. But when we have nested <code>with mock_open</code> blocks the file returned by the <code>open()</code> function in <code>mock_file</code> might actually have been mocked by an enclosing context manager and its type would then be <code>StringIO</code>.</p>

	<p>The <code>try: except:</code> block around <code>yield</code> is for the enclosing context managers. When they get a <code>NotMocked</code> exception by running the code inside them, they check if it&#8217;s the file they&#8217;re mocking, in which case they ignore it. (Basically telling the nested context manager: <em>I&#8217;ve got you covered.</em>). If the <code>NotMocked</code> exception was raised on a file that&#8217;s different than the one they&#8217;re mocking, they simply re-raise it for someone else to deal with (either an enclosing context-manager) or the user.</p>

	<p>If we now added another <code>open()</code> call in our initial <code>get_proxy()</code> function, or inside the with statement in the test case,</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_proxy_url_not_in_sysproxy_but_in_yastproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">SYS_PROXY</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">CURL_PROXY</span><span class="p">,</span> <span class="s1">&#39; --proxy &#39;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
            <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/dev/null&#39;</span><span class="p">)</span>
</pre></div>
</div>

	<p>we&#8217;d get this error:</p>

<pre>NotMocked: The file /dev/null was opened, but not mocked.</pre>

	<p>Cool. Now how about the opposite? I had to refactor a lot of these test cases and at some point I wasn&#8217;t sure that all those assertions made sense. Was I really hitting all the files I had mocked? Well we could just add another check in our <code>mock_open()</code> code to see if all the files that were mocked, were actually accessed
 by the test code:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">mock_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">complain</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">open_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">mock_file</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">open_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="n">mocked_file</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_file</span><span class="p">)</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="n">NotMocked</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">filename</span> <span class="o">!=</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">open_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;The file </span><span class="si">%s</span><span class="s2"> was not opened.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">open_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">complain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotMocked</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</pre></div>
</div>

	<p>We now track mocked files as <code>open_files</code>, too. Then at the end, we simply check if the file that we were supposed to be mocking (passed in as the <code>filename</code> argument) was indeed opened.</p>

	<p>The gotcha here is that we need to raise this exception before <code>NotMocked</code>, otherwise we risk the code not ever getting to the file-not-opened check. I guess this is where the difference between using exceptions when something exceptional occured vs. when you want to communicate with the enclosing function becomes obvious.</p>

	<p>If we now added another <code>mock_open</code> that we weren&#8217;t using to the test code:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_proxy_url_not_in_sysproxy_but_in_yastproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">SYS_PROXY</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="n">CURL_PROXY</span><span class="p">,</span> <span class="s1">&#39; --proxy &#39;</span> <span class="o">+</span> <span class="n">TEST_PROXY</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">mock_open</span><span class="p">(</span><span class="s1">&#39;/dev/null&#39;</span><span class="p">):</span>
                <span class="n">get_proxy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">TEST_PROXY</span><span class="p">,</span> <span class="n">get_proxy</span><span class="p">())</span>
</pre></div>
</div>

	<p>We&#8217;d get:</p>

<pre>AssertionError: The file /dev/null was not opened.</pre>

	<p><span class="caps">EDIT</span>: Eric Moyer found a bug (and suggested a fix) in this implementation. When the same file is opened multiple times, the <code>open_files</code> list will contain the filename multiple times, but it will only get <code>remove</code>-ed once. This can be easily solved by making the <code>open_files</code> list a set instead.</p>

	<p><span class="caps">EDIT</span> (March 14, 2018): Santiago Castro found another bug (and suggested a fix) in this implementation. If the call to builtins.open() raises an error, the mock will stay stopped for future calls. We need to wrap it in a try-finally block.</p>

	<p>So that&#8217;s about it, we now have a rock-solid <code>mock_open</code> function for mocking the builtin <code>open()</code>.</p>

	<p>Before we set it free, we need to add a nice docstring to it:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">mock_open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">contents</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">complain</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mock the open() builtin function on a specific filename</span>
<span class="sd">.</span>
<span class="sd">    Let execution pass through to open() on files different than</span>
<span class="sd">    :filename:. Return a StringIO with :contents: if the file was</span>
<span class="sd">    matched. If the :contents: parameter is not given or if it is None,</span>
<span class="sd">    a StringIO instance simulating an empty file is returned.</span>
<span class="sd">.</span>
<span class="sd">    If :complain: is True (default), will raise an AssertionError if</span>
<span class="sd">    :filename: was not opened in the enclosed block. A NotMocked</span>
<span class="sd">    exception will be raised if open() was called with a file that was</span>
<span class="sd">    not mocked by mock_open.</span>
<span class="sd">.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">open_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">mock_file</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">open_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="n">mocked_file</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.open&#39;</span><span class="p">,</span> <span class="n">mock_file</span><span class="p">)</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="n">NotMocked</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">filename</span> <span class="o">!=</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="n">mocked_file</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">open_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">complain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;The file </span><span class="si">%s</span><span class="s2"> was not opened.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">open_files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">complain</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotMocked</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</pre></div>
</div>
        </div>
        <div class="post_tags postmeta">
          tags:
                <a href="/tag/programming.html">programming</a>
                <a href="/tag/python.html">python</a>
        </div>
        <a href="http://mapleoin.github.io/perma/mocking-python-file-open#disqus_thread" class="comments">Comments</a>
    </article>
    <article id="testing-django-models">
        <h2><a href="http://mapleoin.github.io/perma/testing-django-models">testing a django blog's models</a></h2>
        <div class="postmeta">Thursday, September 25, 2008</div>

        <div class="entry">
            	<p>This post is a continuation of <a href="http://mapleoin.eu/perma/blog-database-schema-2/">this post</a> and I&#8217;ll be using that schema to write tests on top of. Here it is, for easy reference:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">nume</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">)</span>
    <span class="n">published</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">creation_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">modified_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Commentator</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">website</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">verify_exists</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Post</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Commentator</span><span class="p">)</span>
    <span class="n">approved</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">creation_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>

	<p>Ok, so here&#8217;s what we&#8217;re testing: our model &#8212; the emphasis is on <i>our</i>, because we&#8217;re only testing our code. And mostly, we&#8217;re actually testing that the code in models.py corresponds with what&#8217;s in the database. All test methods must begin with the word <i>test</i>.</p>

	<p>One of the most annoying things which took me a while to figure out was that the <strong>setUp</strong> method is run <i>every time</i> before one of the other methods is run. That means that if you want to test for uniqueness, you <i>have to</i> build a <strong>tearDown</strong> method if you want to run any other independent tests. This is why snippet A won&#8217;t work, but snippet B will.<br />
Here&#8217;s the model:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>

	<h4>snippet A</h4>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CategoryTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cat1</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cat1&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">testexist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># make sure they get to the database</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;cat1&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">testunique</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cat1&quot;</span><span class="p">)</span>
</pre></div>
</div>

	<h4>snippet B</h4>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CategoryTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cat1</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cat1&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">testexist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># make sure they get to the database</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;cat1&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cat1&quot;</span><span class="p">)</span>
</pre></div>
</div>

	<p>The second snippet only calls the <strong>setUp</strong> method once because there is only one other method. But that&#8217;s not very nice. Ideally we&#8217;d to be able to run each test individually, so maybe we can write a <strong>tearDown</strong> method to be run after each other method, to restore the database.</p>

	<p>However, there is an easier way to not have to write a <strong>tearDown</strong> method and that is using the <strong>django.test</strong> module which is an extention to unittest. All you have to do is <strong>import django.test</strong> instead of <strong>unittest</strong> and make every test object a sublclass of <strong>django.test.TestCase</strong> instead of <strong>unittest.TestCase</strong>.<br />
Here is what it looks like now:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CategoryTest</span><span class="p">(</span><span class="n">django</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat1</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cat1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat2</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cat2&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testexist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make sure they get to the database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;cat1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;cat2&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testunique</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cat1&quot;</span><span class="p">)</span>
</pre></div>
</div>

	<p>Now, let&#8217;s test the <strong>Post class</strong>:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">)</span>
    <span class="n">published</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">creation_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">modified_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>

	<p>There&#8217;s a bunch more stuff to test here, like the fact that everything gets to the database (title, body, category) and that everything has it&#8217;s right type/class.<br />
We setUp a post, but also a category, since the test will be independent, but needs a Category to generate a Post.</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PostTest</span><span class="p">(</span><span class="n">django</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat1</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cat1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post1</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="n">body</span><span class="o">=</span><span class="s2">&quot;trala lala&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>

	<p>Next, we need to do a bit of a <i>trivial</i> test to check that the title, the body and the right category get to the db</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">testtrivial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;trala lala&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>

	<p>I think this is a good way to test that the creation_time and modified_time are newly generated datetime.datetime objects:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">testtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">creation_time</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
</pre></div>
</div>

	<p>No, wait. I think this looks a bit more professional:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">testtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">creation_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">seconds</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">delta_modified</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">modified_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_</span><span class="p">(</span><span class="n">delta_modified</span><span class="o">.</span><span class="n">seconds</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>

	<p>So now, we&#8217;re looking for datetime objects that were generated less than 10 seconds ago. That&#8217;s really very generous since the time it takes to run the test from the time the <i>setUp</i> method is run is in the range of microseconds.<br />
This test doesn&#8217;t show the true difference between modified and creation time. Modification time is changed every time the object is <i>saved</i> to the database while creation time is not. So let&#8217;s write a new test based on that knowledge:</p>

<div class="Python"><div class="highlight"><pre><span></span> <span class="k">def</span> <span class="nf">testModifiedVsCreation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">modified_time</span>
        <span class="n">created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">creation_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">modified</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">modified_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">created</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">creation_time</span><span class="p">)</span>
</pre></div>
</div>

	<p>Testing for a boolean value is really easy:</p>

<div class="Python"><div class="highlight"><pre><span></span> <span class="k">def</span> <span class="nf">testpublished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">published</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>

	<p>And then there&#8217;s more than one way I can think of to test the Category ForeignKey:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">testcategory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat1</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="s2">&quot;tralaalal&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;ooopsie!&quot;</span><span class="p">)</span>
</pre></div>
</div>

	<p>In the end, I&#8217;ll go for the more general one, even though the second one is more excentric. So:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">testcategory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat1</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post1</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
                <span class="n">body</span><span class="o">=</span><span class="s2">&quot;tralaalal&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s2">&quot;ooopsie!&quot;</span><span class="p">)</span>
</pre></div>
</div>

	<p>Btw, if you don&#8217;t know the errors (like ValueError &#8212; I didn&#8217;t know it), you can always drop to a <i>manage.py console</i> and try to <code>Post.object.create(name="name",body="tralaalal", category="ooopsie!")</code> and see if you get lucky.</p>

	<p>Ok, passing on to the Commentator class:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Commentator</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">website</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">verify_exists</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>

	<p>We&#8217;re only going to test that the data gets to the database and that the <i>name</i> and <i>email</i> fields are unique. At this stage we can&#8217;t test the validation of the <i>email</i> and <i>website</i> fields. We&#8217;ll be doing that later, when we write the <a href="http://docs.djangoproject.com/en/dev/ref/forms/validation/">forms</a>.<br />
This should seem trivial by now:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CommentatorTest</span><span class="p">(</span><span class="n">django</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comtor</span> <span class="o">=</span> <span class="n">Commentator</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;hacketyhack&quot;</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="s2">&quot;hackety@example.com&quot;</span><span class="p">,</span> <span class="n">website</span><span class="o">=</span><span class="s2">&quot;example.com&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testExist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comtor</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;hacketyhack&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comtor</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s2">&quot;hackety@example.com&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comtor</span><span class="o">.</span><span class="n">website</span><span class="p">,</span> <span class="s2">&quot;example.com&quot;</span><span class="p">)</span>
     <span class="k">def</span> <span class="nf">testUnique</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">Commentator</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;hacketyhack&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;new@example.com&quot;</span><span class="p">,</span>
                <span class="n">website</span><span class="o">=</span><span class="s2">&quot;example.com&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">Commentator</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;nothackety&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;hackety@example.com&quot;</span><span class="p">,</span>
                <span class="n">website</span><span class="o">=</span><span class="s2">&quot;example.com&quot;</span><span class="p">)</span>
</pre></div>
</div>

	<p>Now, let&#8217;s get to testing the Comment class:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Post</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Commentator</span><span class="p">)</span>
    <span class="n">approved</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">creation_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>

	<p>There won&#8217;t be anything new here. And this is when and why testing is <i>boring</i>. But, hey! A man&#8217;s gotta do, what a man&#8217;s gotta do.</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CommentTest</span><span class="p">(</span><span class="n">django</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;cat1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="n">body</span><span class="o">=</span><span class="s2">&quot;trala lala&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comtor</span> <span class="o">=</span> <span class="n">Commentator</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;hacketyhack&quot;</span><span class="p">,</span>
                <span class="n">email</span><span class="o">=</span><span class="s2">&quot;hackety@example.com&quot;</span><span class="p">,</span> <span class="n">website</span><span class="o">=</span><span class="s2">&quot;example.com&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">com</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="s2">&quot;If the implementation is</span>
        <span class="n">easy</span> <span class="n">to</span> <span class="n">explain</span><span class="p">,</span> <span class="n">it</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="n">good</span> <span class="n">idea</span><span class="o">.</span><span class="s2">&quot;,</span>
        <span class="n">post</span><span class="o">=</span><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">author</span><span class="o">=</span><span class="n">Commentator</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">testExist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;If the implementation is</span>
        <span class="n">easy</span> <span class="n">to</span> <span class="n">explain</span><span class="p">,</span> <span class="n">it</span> <span class="n">may</span> <span class="n">be</span> <span class="n">a</span> <span class="n">good</span> <span class="n">idea</span><span class="o">.</span><span class="s2">&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">Commentator</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">approved</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testTime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">delta_creation</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">creation_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_</span><span class="p">(</span><span class="n">delta_creation</span><span class="o">.</span><span class="n">seconds</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">testCreationTime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># what if it&#39;s a modification_time instead?</span>
        <span class="n">created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">creation_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">created</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">creation_time</span><span class="p">)</span>
</pre></div>
</div>

	<p>Now that we&#8217;ve written all the tests we have to make sure that they&#8217;re run against the actual database. Or better yet, a backup copy of it. Otherwise, the tests are useless, since django creates a new database <strong>based on the schema defined in models.py</strong> every time <i>models.py test</i> is run.</p>

	<p>First, you&#8217;ll need to make a copy of django.test.simple (put it in your project&#8217;s directory for example). Then comment these lines:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="c1"># old_name = settings.DATABASE_NAME</span>
<span class="c1"># from django.db import connection</span>
<span class="c1"># connection.creation.create_test_db(verbosity, autoclobber=not interactive)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
<span class="c1"># connection.creation.destroy_test_db(old_name, verbosity)</span>
</pre></div>
</div>

	<p>And now, add this to your settings.py file:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="n">TEST_RUNNER</span> <span class="o">=</span> <span class="s1">&#39;myproject.simple.run_tests&#39;</span>
</pre></div>
</div>

	<p>Be careful now. All the data in your database <strong>will</strong> be lost when you run <i>manage.py test</i> the next time. So back it up! First create a new database, say <i>backup</i> and then:</p>

<div class="Bash"><div class="highlight"><pre><span></span>mysqldump -u DB_USER --password<span class="o">=</span>DB_PASS DB_NAME<span class="p">|</span>mysql -u DB_USER --password<span class="o">=</span>DB_PASSWD -h localhost backup
</pre></div>
</div>

	<p>You can reverse that when you&#8217;re done.</p>

	<p>Here&#8217;s to show that it works (after I&#8217;ve made a little modification to the model, but not the database):</p>

<div class="Bash"><div class="highlight"><pre><span></span>$ python manage.py <span class="nb">test</span>
..EEE..EEEEEE................
--&gt; lots of tracebacks &lt;--
----------------------------------------------------------------------
Ran <span class="m">29</span> tests in <span class="m">10</span>.149s
FAILED <span class="o">(</span><span class="nv">errors</span><span class="o">=</span><span class="m">9</span><span class="o">)</span>
</pre></div>
</div>

	<p>Ok, so that should provide a pretty good test coverage for now. Let&#8217;s go get breakfast!</p>
        </div>
        <div class="post_tags postmeta">
          tags:
                <a href="/tag/programming.html">programming</a>
                <a href="/tag/django.html">django</a>
                <a href="/tag/python.html">python</a>
        </div>
        <a href="http://mapleoin.github.io/perma/testing-django-models#disqus_thread" class="comments">Comments</a>
    </article>
    <article id="blog-database-schema-2">
        <h2><a href="http://mapleoin.github.io/perma/blog-database-schema-2">blog database schema cu capsuni - Part 2</a></h2>
        <div class="postmeta">Monday, September 22, 2008</div>

        <div class="entry">
            	<p>Tocmai am reușit (am găsit timp &#8212; furat timp) să scriu în django schema din <a href="http://mapleoin.eu/perma/blog-database-schema">postul trecut</a>. Simplicity is divine:</p>

<div class="Python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="k">class</span> <span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">nume</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Post</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">)</span>
    <span class="n">published</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">creation_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Commentator</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">website</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">verify_exists</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Post</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Commentator</span><span class="p">)</span>
    <span class="n">approved</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">()</span>
    <span class="n">modified_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>

	<p>Pe lângă faptul că toate tipurile de date au nume și <a href="http://docs.djangoproject.com/en/dev/ref/models/fields/#model-field-types">explicații</a> pe care le poate înțelege oricine, django va folosi datele astea atunci când va construi interfața de administrare.<br />
E interesant că trebuie să declari toate tabelele în ordine. La început pusesem Categoria ultima și n-o găsea când vroia să facă ForeignKey-ul de la Post. M-a cam răsfățat <span class="caps">OOP</span>-ul.<br />
Alt lucru fain e că de pe acum se pregătesc feature-uri interesante cum ar fi <span class="caps">URLF</span>ield.verify_exists care verifică toate url-urile introduse și le refuză dacă primește <a href="http://en.wikipedia.org/wiki/HTTP_404">404</a>. Așa că de-acum n-o să mai poată nimeni să pună <a href="http://en.wikipedia.org/wiki/Metasyntactic_variable">variabile metasintactice</a> de genu: <i>caca</i>, <i>mumu</i> și altele în field-ul ăla!</p>

	<p>Și acum un mysql describe<sup class="footnote" id="fnreve24e7ece36594b7dbf449a897152e2eb-1"><a href="#fne24e7ece36594b7dbf449a897152e2eb-1">3</a></sup> pentru tabelele rezultate:</p>

<div class="MySQL"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">describe</span> <span class="n">revolution</span><span class="p">.</span><span class="n">blahg_category</span><span class="p">;</span>
 <span class="o">+-------+-------------+------+-----+---------+</span>
 <span class="o">|</span> <span class="n">Field</span> <span class="o">|</span> <span class="n">Type</span>        <span class="o">|</span> <span class="no">Null</span> <span class="o">|</span> <span class="k">Key</span> <span class="o">|</span> <span class="k">Default</span> <span class="o">|</span>
 <span class="o">+-------+-------------+------+-----+---------+</span>
 <span class="o">|</span> <span class="n">id</span>    <span class="o">|</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>     <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span> <span class="n">PRI</span> <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">|</span> <span class="n">nume</span>  <span class="o">|</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span>     <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">+-------+-------------+------+-----+---------+</span>
 <span class="n">mysql</span><span class="o">&gt;</span> <span class="k">describe</span> <span class="n">revolution</span><span class="p">.</span><span class="n">blahg_post</span><span class="p">;</span>
 <span class="o">+---------------+-------------+------+-----+---------+</span>
 <span class="o">|</span> <span class="n">Field</span>         <span class="o">|</span> <span class="n">Type</span>        <span class="o">|</span> <span class="no">Null</span> <span class="o">|</span> <span class="k">Key</span> <span class="o">|</span> <span class="k">Default</span> <span class="o">|</span>
 <span class="o">+---------------+-------------+------+-----+---------+</span>
 <span class="o">|</span> <span class="n">id</span>            <span class="o">|</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>     <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span> <span class="n">PRI</span> <span class="o">|</span> <span class="no">NULL</span>    
 <span class="o">|</span> <span class="n">title</span>         <span class="o">|</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span>     <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">|</span> <span class="n">body</span>          <span class="o">|</span> <span class="kt">longtext</span>    <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span>     <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">|</span> <span class="n">category_id</span>   <span class="o">|</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>     <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span> <span class="n">MUL</span> <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">|</span> <span class="n">published</span>     <span class="o">|</span> <span class="kt">tinyint</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span>     <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">|</span> <span class="n">creation_time</span> <span class="o">|</span> <span class="kt">datetime</span>    <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span>     <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">|</span> <span class="n">modified_time</span> <span class="o">|</span> <span class="kt">datetime</span>    <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span>     <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">+---------------+-------------+------+-----+---------+</span>
 <span class="n">mysql</span><span class="o">&gt;</span> <span class="k">describe</span> <span class="n">revolution</span><span class="p">.</span><span class="n">blahg_commentator</span><span class="p">;</span>
 <span class="o">+---------+--------------+------+-----+---------+</span>
 <span class="o">|</span> <span class="n">Field</span>   <span class="o">|</span> <span class="n">Type</span>         <span class="o">|</span> <span class="no">Null</span> <span class="o">|</span> <span class="k">Key</span> <span class="o">|</span> <span class="k">Default</span> <span class="o">|</span> 
 <span class="o">+---------+--------------+------+-----+---------+</span>
 <span class="o">|</span> <span class="n">id</span>      <span class="o">|</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>      <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span> <span class="n">PRI</span> <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">|</span> <span class="n">name</span>    <span class="o">|</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span> <span class="n">UNI</span> <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">|</span> <span class="n">email</span>   <span class="o">|</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span> <span class="n">UNI</span> <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">|</span> <span class="n">website</span> <span class="o">|</span> <span class="kt">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span>     <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">+---------+--------------+------+-----+---------+</span>
 <span class="n">mysql</span><span class="o">&gt;</span> <span class="k">describe</span> <span class="n">revolution</span><span class="p">.</span><span class="n">blahg_comment</span><span class="p">;</span>
 <span class="o">+---------------+------------+------+-----+---------+</span>
 <span class="o">|</span> <span class="n">Field</span>         <span class="o">|</span> <span class="n">Type</span>       <span class="o">|</span> <span class="no">Null</span> <span class="o">|</span> <span class="k">Key</span> <span class="o">|</span> <span class="k">Default</span> <span class="o">|</span>
 <span class="o">+---------------+------------+------+-----+---------+</span>
 <span class="o">|</span> <span class="n">id</span>            <span class="o">|</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>    <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span> <span class="n">PRI</span> <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span> 
 <span class="o">|</span> <span class="n">body</span>          <span class="o">|</span> <span class="kt">longtext</span>   <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span>     <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">|</span> <span class="n">post_id</span>       <span class="o">|</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>    <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span> <span class="n">MUL</span> <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span> 
 <span class="o">|</span> <span class="n">author_id</span>     <span class="o">|</span> <span class="kt">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>    <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span> <span class="n">MUL</span> <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">|</span> <span class="n">approved</span>      <span class="o">|</span> <span class="kt">tinyint</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span>     <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">|</span> <span class="n">modified_time</span> <span class="o">|</span> <span class="kt">datetime</span>   <span class="o">|</span> <span class="n">NO</span>   <span class="o">|</span>     <span class="o">|</span> <span class="no">NULL</span>    <span class="o">|</span>
 <span class="o">+---------------+------------+------+-----+---------+</span>
</pre></div>
</div>

	<p><span class="caps">TADA</span>!<br />
Trebuie să studiez de ce se strică formatarea (de fapt știu de ce, trebuie să scot textile din blockul ăla), dar ideea de bază e clară.</p>

	<p class="footnote" id="fne24e7ece36594b7dbf449a897152e2eb-1"><sup>3</sup> merci gheorghe!</p>
        </div>
        <div class="post_tags postmeta">
          tags:
                <a href="/tag/programming.html">programming</a>
                <a href="/tag/databases.html">databases</a>
                <a href="/tag/django.html">django</a>
                <a href="/tag/python.html">python</a>
        </div>
        <a href="http://mapleoin.github.io/perma/blog-database-schema-2#disqus_thread" class="comments">Comments</a>
    </article>
    <article id="blog-database-schema">
        <h2><a href="http://mapleoin.github.io/perma/blog-database-schema">blog database schema cu capsuni</a></h2>
        <div class="postmeta">Tuesday, September 16, 2008</div>

        <div class="entry">
            	<p>Am reușit să-mi scriu schema bazei de date a viitorului meu blog. Ah, da, m-am apucat de treabă. O să folosesc django cred (și deja mi s-a spus că era previzibil) deși încă mai am timp să mă răzgândesc. N-am găsit în 2 minute un script care să-mi deseneze scheme, așa că pun relațiile în engleză aici. Come bash me!</p>

	<h4>Post</h4>

	<ul>
		<li><code>belongs_to Category</code></li>
		<li><code>has_many Comments</code></li>
	</ul>

	<h4>Comment</h4>

	<ul>
		<li><code>has_one Commentator</code></li>
		<li><code>belongs_to Post</code></li>
	</ul>

	<h4>Commentator</h4>

	<ul>
		<li><code>has_many Comments</code></li>
	</ul>

	<h4>Category</h4>

	<ul>
		<li><code>has_many Posts</code></li>
	</ul>

	<p>Ia să încerc să fac și niște tabele din ce scrie mai sus.</p>

	<p>Post<br />
<code>id || title || body || category_id || created_at || published</code></p>

	<p>Comment<br />
<code>id || post_id || commentator_id || body || approved || created_at</code></p>

	<p>Commentator<br />
<code>id || name || email || website || gravatar_url</code></p>

	<p>Category<br />
<code>id || name</code></p>

	<p>Am renunțat la tabele și am improvizat o formatare. Sper să fie lizibil.</p>

	<p>E evident ceea ce <strong>nu</strong> am făcut sper. Nu am lăsat commentatorii cu commenturile lor ceea ce ar fi dus la o relație cu 4 coloane redundante (nume, email, website, gravatar):</p>

	<p>Comment<br />
id || <span style="color:red;">autor || email || website || gravatar_url</span> || post_id || commentator_id || body || approved || created_at</p>

	<p>Pe parcurs o să mai adaug rating la posturi și alte lucruri care mai îmi vin în minte. Ratingul o să încerce să fie ceva complex cu sus/jos, dar asta mai târziu. <br />
Deci? Ce părere aveți? Ce să mai adaug? Am greșit ceva? Mă încadrez în forma normală 5? :-)</p>
        </div>
        <div class="post_tags postmeta">
          tags:
                <a href="/tag/django.html">django</a>
                <a href="/tag/programming.html">programming</a>
                <a href="/tag/python.html">python</a>
                <a href="/tag/databases.html">databases</a>
        </div>
        <a href="http://mapleoin.github.io/perma/blog-database-schema#disqus_thread" class="comments">Comments</a>
    </article>
</div>
<div style="clear: right;"></div>
</div><!-- container -->
<div id="smallprint"><a rel="license" href="https://creativecommons.org/licenses/by/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/3.0/80x15.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution 3.0 Unported License</a>.</div>

<script id="dsq-count-scr" src="//revolutionblahg.disqus.com/count.js" async></script>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-5576939-1");
pageTracker._trackPageview();
} catch(err) {}</script>
</body>
</html>
